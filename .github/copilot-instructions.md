# Copilot Instructions for CNTLM

This is a summary of the CNTLM codebase, its structure, conventions, and key patterns to help AI agents (like GitHub Copilot) assist effectively.
For more details, see `README.md` and comments in each module. When in doubt, follow the structure and patterns of existing code.

## Project Overview
- CNTLM is a fast and efficient NTLM/NTLMv2 authenticating HTTP proxy, written in C for cross-platform use (Linux, Windows, macOS, *BSD, AIX).
- The codebase is organized by functional modules: authentication (`auth.c`), configuration (`config.c`), proxy logic (`proxy.c`), NTLM protocol (`ntlm.c`), and utility functions (`utils.c`).
- Windows-specific and packaging logic is under the `win/` directory; platform compatibility code is in `config/`.

## Build & Install
- Standard build: `./configure && make && make install`
- Windows build (Cygwin):
  - Install required Cygwin packages: `gcc-core`, `make`, `ghostscript`, `dos2unix`, `zip`, `cygrunsrv`.
  - Run: `./configure && make` (from Cygwin shell)
  - To create a Windows installer: `make win` (uses InnoSetup script in `win/setup.iss`)
- Packaging: `make deb`, `make rpm`, `make tgz`, `make tbz2` for various package formats.

## Key Patterns & Conventions
- System-wide config is loaded from a hardcoded path (default `/etc/cntlm.conf`), unless overridden with `-c`.
- No dynamic library dependencies except for pthreads (threading; required for concurrency, see `utils.c`).
- Platform-specific code is isolated in `config/` and `win/`.
- Endianness is auto-detected at build time (relevant for protocol-level operations).
- All binaries, man pages, and config templates are generated by the build system; see `Makefile` and `configure`.

## Testing & CI
- CI is configured for Linux (GitHub Actions) and Windows (AppVeyor).
- Code quality is monitored via SonarCloud, Coverity, Codacy, and CodeQL (see badges in `README.md`).
- No explicit test suite is present. Manual and integration testing is expected: run CNTLM with a sample config, use `curl` or a browser to verify proxying and authentication, and check logs for errors.

## Notable Files & Directories
- `main.c`: Entry point, daemon logic.
- `config/`: Platform compatibility shims (e.g., `arc4random_buf.c`, `gethostname.c`).
- `win/`: Windows installer resources and InnoSetup scripts.
- `doc/`: Man page, config samples, and init scripts.
- `debian/`, `rpm/`: Packaging metadata for respective systems.

## Contribution & Coding Style
- Follow existing C code style (K&R, 4-space indents, braces on same line).
- Use platform abstraction layers for OS-specific logic.
- Keep all configuration and secrets handling in `config.c` and `config.h`. Always wipe secrets from memory after use with `compat_memset_s` or similar.
- Use `myexit` and `croak` for controlled process termination and error reporting, not raw `exit` or `abort`.
- Document any new build or packaging steps in `README.md`.

## Example: Adding a New Auth Method
- Implement protocol logic in a new file (e.g., `auth_foo.c`), update `Makefile`.
- Register the method in `auth.c` and expose config in `config.c`.
- Update documentation in `README.md` and `doc/` as needed.
- When extending protocols or authentication, keep logic isolated and follow the registration pattern in `auth.c`.

## Frequently Used Utility Functions
- `zmalloc(size_t size)`: Allocates zero-initialized memory of the given size (wrapper for `calloc`). Used throughout the codebase for safe memory allocation. Returns a pointer to the allocated memory or `NULL` on failure. Example usage: `ptr = zmalloc(nbytes);`.
- `myexit(int rc)`: Terminates the process with the given return code. Used for controlled exits on fatal errors.
- `croak(const char *msg, int console)`: Prints an error message and terminates the process.
- `hlist_*` and `plist_*`: Single-linked list helpers for managing headers and cached connections. See `utils.h` for available operations (add, delete, duplicate, count, etc.).
- `lowercase(char *str)`, `uppercase(char *str)`: In-place string case conversion utilities.
- `compat_memset_s(void *dest, size_t destsz, char ch, size_t count)`: Secure memory clearing function, used to wipe sensitive data (e.g., passwords) from memory.

Refer to `utils.c` and `utils.h` for more details and additional helpers. When reviewing or generating code, prefer these wrappers over direct use of `malloc`, `free`, or raw memory operations for consistency and safety.

## Security Practices
- All code that processes, stores, or manipulates sensitive information—such as passwords, NTLM hashes, or authentication tokens—should be implemented only in `config.c`, `config.h`, or the authentication protocol modules (`auth.c`, `ntlm.c`, `kerberos.c`, etc.).
- Do not handle secrets (e.g., read, write, store, or modify passwords or hashes) in unrelated modules like `proxy.c`, `main.c`, or utility code. This centralizes sensitive logic, making it easier to audit, secure, and ensure secrets are properly wiped from memory.
- Always wipe sensitive data from memory after use.

## Threading Model
- CNTLM uses pthreads for concurrency. Thread management helpers and argument structures are in `utils.c` and `utils.h`.

## AI Agent Guidance
Whenever you (Copilot or any LLM-based agent or even humans) make or review changes to this codebase, check if these instructions are still accurate. If you notice that something is no longer correct or complete, highlight the issue and suggest corrections or updates to this file.
